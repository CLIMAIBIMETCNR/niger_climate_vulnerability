library(raster)
library(XLConnect)
library(velox)
library(lubridate)
library(trend)



NER_admin1=readRDS("data/gis/NER_admin1.rds")
NER_admin2=readRDS("data/gis/NER_admin2.rds")
projndviNER=readRDS("data/gis/ndvi_proj4.rds")

NER_admin2_ndvi=spTransform(NER_admin2,CRS(projndviNER))
NER_admin1_ndvi=spTransform(NER_admin1,CRS(projndviNER))


########################################################################################################################
# functions to detect trend occurence , trend magnitude and p.values

mk_sens=function(x) {if (length(which(is.na(x)))>0) { NA } else {as.numeric(mk.test(ts(x))$p.value)}}
sign_sens=function(x) {if (length(which(is.na(x)))>0) { NA } else {as.numeric(sens.slope(ts(x))$p.value)}}
slo_sens=function(x) {if (length(which(is.na(x)))>0) { NA } else {as.numeric(sens.slope(ts(x))$estimates)}}

########################################################################################################################
# functions to detect  trend magnitude by linear modeling

pvalslmfit=function(m) {
  rss <- sum(m$residuals^2)
  rdf <- length(m$residuals) - m$rank
  resvar <- rss/rdf
  R <- chol2inv(m$qr)
  se <- sqrt(diag(R) * resvar)
  return(2*pt(abs(m$coef/se),rdf,lower.tail=FALSE))
}

funslope=function(x,...) { if (length(which(is.na(x)))>0) { NA } else { .lm.fit(cbind(1,as.matrix(1:length(x))),as.numeric(x))$coefficients[1] }}
funslopep=function(x,...) { if ((length(which(is.na(x)))>0)){ NA } else { m = .lm.fit(cbind(1,as.matrix(1:length(x))),as.numeric(x)); pvalslmfit(m)[1] }}

########################################################################################################################
# Analising vegetation by using mean annual NDVI

ndvi=stack(brick("../images_ndvi/nig_NDVI_mean.nc"))
proj4string(ndvi)=projndviNER

mk.test=calc(ndvi, mk_sens)
ndvi.slope=calc(ndvi, slo_sens)
pndvi.slope=calc(ndvi, sign_sens)

writeRaster(ndvi.slope,"../images_ndvi/ndvislope.tif",overwrite=T)

system("gdalwarp -t_srs EPSG:4326 ../images_ndvi/ndvislope.tif ../images_ndvi/ndvislope_geo.tif")

writeRaster(pndvi.slope,"../images_ndvi/pndvislope.tif",overwrite=T)

system("gdalwarp -t_srs EPSG:4326 ../images_ndvi/pndvislope.tif ../images_ndvi/pndvislope_geo.tif")

writeRaster(mk.test,"../images_ndvi/pmk_test_ndvi.tif",overwrite=T)

system("gdalwarp -t_srs EPSG:4326 ../images_ndvi/pmk_test_ndvi.tif ../images_ndvi/pmk_test_ndvi_geo.tif")


ndvi.mean=calc(ndvi, mean,na.rm=T)
writeRaster(ndvi.mean,"../images_ndvi/ndvimean.tif",overwrite=T)
system("gdalwarp -t_srs EPSG:4326 ../images_ndvi/ndvimean.tif ../images_ndvi/ndvimean_geo.tif")

########################################################################################################################
# Analising precipitation by using max daily rainfalls RFE 

rainrfe=stack(brick("../rainfall_data_netcdf/niger_max_rfe.nc"))
rainrfe.pmk=calc(rainrfe, mk_sens)
rainrfe.slope=calc(rainrfe, slo_sens)
prainrfe.slope=calc(rainrfe, sign_sens)

writeRaster(rainrfe.pmk,"../images_rainfall/rainrfe.pmk.tif",overwrite=T)
writeRaster(rainrfe.slope,"../images_rainfall/rainrfe.slope.tif",overwrite=T)
writeRaster(prainrfe.slope,"../images_rainfall/prainrfe.slope.tif",overwrite=T)

########################################################################################################################

# Analising precipitation by using max daily rainfalls CHIRPS

rain=stack(brick("../rainfall_data_netcdf/niger_max_chirps_2000_2015.nc"))
rain.pmk=calc(rain,  mk_sens)
rain.slope=calc(rain, slo_sens)
prain.slope=calc(rain, sign_sens)

writeRaster(rain.pmk,"../images_rainfall/rain.pmk.tif",overwrite=T)
writeRaster(rain.slope,"../images_rainfall/rain.slope.tif",overwrite=T)
writeRaster(prain.slope,"../images_rainfall/prain.slope.tif",overwrite=T)
