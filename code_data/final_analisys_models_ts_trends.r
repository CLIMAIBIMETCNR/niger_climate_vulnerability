library(rgdal)
library(readxl)
library(doBy)
library(lubridate)
library(trend)
library(XLConnect)
library(fmsb)


#################################################################################################################
# Load libraries and functions

source("NER_aux.r")

#################################################################################################################
# Load data


NIGER_nazione=readRDS("data/gis/NIGER_nazione.rds")
NIGER_dipartimenti=readRDS("data/gis/NIGER_dipartimenti.rds")
loc_inondate=readRDS("data/gis/loc_inondate.rds")
massiccio_air=readRDS("data/gis/massiccio_air.rds")

da_year_dep_ls=readRDS("data/damages/da_year_dep_ls.rds")
freq_loc_flood=readRDS("data/damages/freq_loc_flood.rds")
danni_anadia=readRDS("data/damages/matrice_DA.rds")

#####################àà##############################################################


rain_var=list.files(path="data/climateveg",pattern="NER_rain.xls",full.names = T)
ndvi_var=list.files(path="data/climateveg",pattern="ADM2_NDVI",full.names = T)
evi_var=list.files(path="data/climateveg",pattern="ADM2_EVI",full.names = T)
air_NDVI=list.files(path="data/climateveg",pattern="aire_NDVI",full.names = T)
air_EVI=list.files(path="data/climateveg",pattern="aire_EVI",full.names = T)

ndvi_var_data=lapply(ndvi_var,read_excel)
evi_var_data=lapply(evi_var,read_excel)
air_NDVI_data=lapply(air_NDVI,read_excel)
air_EVI_data=lapply(air_EVI,read_excel)

ndvi_var_data[[1]]$yr=year(as.Date(ndvi_var_data[[1]]$dates))
evi_var_data[[1]]$yr=year(as.Date(evi_var_data[[1]]$dates))
air_NDVI_data[[1]]$yr=year(as.Date(air_NDVI_data[[1]]$air))
ndvi_var_data[[1]]=as.data.frame(ndvi_var_data[[1]])
evi_var_data[[1]]=as.data.frame(evi_var_data[[1]])
air_NDVI_data[[1]]=as.data.frame(air_NDVI_data[[1]])



rain_data=lapply(rain_var,read_excel)

pop_data=as.data.frame(read_excel("data/Popolazione_dipartimenti.xlsx",sheet=2))


############################################################################################################################################################################
# modeling and capture trends

res_model_dep=list()
res_trend_dep=list()
res_trend_dep_long=list()

res_coefficient_dep_1=list()
res_coefficient_dep_2=list()
res_coefficient_dep_3=list()
res_coefficient_dep_4=list()
res_coefficient_dep_5=list()
res_coefficient_valid_1=list()
res_coefficient_valid_2=list()
res_coefficient_valid_3=list()
res_coefficient_valid_4=list()
res_coefficient_valid_5=list()

name_deps=as.character(unique(NIGER_dipartimenti$DEPARTEMEN))

############################################################################################################################################################################


for ( i in 1:length(name_deps)) {

dep=name_deps[i]
depd=dep
z=grep(paste0("^",depd,"$"),names(da_year_dep_ls[[1]]),perl=T)[1]
if  (dep =="ZINDER I,II,III*") {z=68 }

zveg=grep(dep,names(ndvi_var_data[[1]]))[1]

#ndvi_sd=c(NA,NA,tapply(as.numeric(ndvi_var_data[[1]][,zveg]),ndvi_var_data[[1]]$yr,FUN=sd))
ndvi_mean=c(NA,NA,tapply(as.numeric(ndvi_var_data[[1]][,zveg]),ndvi_var_data[[1]]$yr,FUN=mean))
#ndvi_max=c(NA,NA,tapply(as.numeric(ndvi_var_data[[1]][,zveg]),ndvi_var_data[[1]]$yr,FUN=max))

veg=data.frame(ndvi_mean=as.vector(ndvi_mean))

tab_danni=as.data.frame(cbind(da_year_dep_ls[[1]][,1],
                              do.call("cbind",lapply(da_year_dep_ls,function(x) x[,z]))))
                        

temp=cbind(tab_danni[1:18,],veg,do.call("cbind",lapply(rain_data,function(x) x[18:35,zveg])))
temp_pars_full=cbind(years=1981:2016,do.call("cbind",lapply(rain_data,function(x) x[,zveg])))

names(temp)=c("year",
              "localities",
              "coltures",
              "persons",
              "houses",
              "animals",
              c(names(veg)),
              gsub("_dep_NER_rain.xls","",gsub("data.climateveg/","",rain_var)))

names(temp_pars_full)=c("year",
              gsub("_dep_NER_rain.xls","",gsub("data.climateveg/","",rain_var)))

temp$pop=as.numeric(pop_data[grep(paste0("^",name_deps[i],"$"),pop_data$DEPARTEMEN,perl=T),][5:22])
if ( dep=="ZINDER I,II,III*") {temp$pop=as.numeric(pop_data[66,5:22])}

res_model=list()
res_coefficient_valid_1[[i]]="no"
res_coefficient_valid_2[[i]]="no"
res_coefficient_valid_3[[i]]="no"
res_coefficient_valid_4[[i]]="no"
res_coefficient_valid_5[[i]]="no"

if (sum(temp$localities)>0) {res_coefficient_valid_1[[i]]="yes"; res_model[[1]]=summary(lm(localities~ .-coltures-persons-houses-animals-year-q95-countpix_q95-gp-max,data=temp))}
if (sum(temp$coltures)>0) {res_coefficient_valid_2[[i]]="yes";  res_model[[2]]=summary(lm(coltures~ .-localities-persons-houses-animals-year-q95-countpix_q95-gp-max,data=temp))}
if (sum(temp$persons)>0) { res_coefficient_valid_3[[i]]="yes";res_model[[3]]=summary(lm(persons~ .-localities-coltures-houses-animals-year-q95-countpix_q95-gp-max,data=temp))}
if (sum(temp$houses)>0) { res_coefficient_valid_4[[i]]="yes";res_model[[4]]=summary(lm(houses~ .-localities-coltures-persons-animals-year-q95-countpix_q95-gp-max,data=temp))}
if (sum(temp$animals)>0) { res_coefficient_valid_5[[i]]="yes";res_model[[5]]=summary(lm(animals~ .-localities-coltures-persons-houses-year-q95-countpix_q95-gp-max,data=temp))}

if(!dir.exists("matrix")) {dir.create("matrix")}
write.csv(temp,paste0("matrix/mat_name_",name_deps[i],".csv"),row.names = F)
write.csv(temp_pars_full,paste0("matrix/mat_name_",name_deps[i],"_longTS.csv"),row.names = F)

capture.output(print(paste("Model houses: ",res_coefficient_valid_1[[i]])),file=paste0("models_",name_deps[i],".txt"))
capture.output(print(paste("Model coltures: ",res_coefficient_valid_2[[i]])),file=paste0("models_",name_deps[i],".txt"),append=T)
capture.output(print(paste("Model persons: ",res_coefficient_valid_3[[i]])),file=paste0("models_",name_deps[i],".txt"),append=T)
capture.output(print(paste("Model houses: ",res_coefficient_valid_4[[i]])),file=paste0("models_",name_deps[i],".txt"),append=T)
capture.output(print(paste("Model animals: ",res_coefficient_valid_5[[i]])),file=paste0("models_",name_deps[i],".txt"),append=T)
capture.output(print(res_model),file=paste0("models_",name_deps[i],".txt"),append=T)

res_model_dep[[i]]=res_model

#############################################################################################################
if ( res_coefficient_valid_1[[i]]=="yes") {
temp_1=data.frame(cbind(t(res_model[[1]]$coefficients[,1]),
                        t(res_model[[1]]$coefficients[,4]),
                        as.numeric(pf(res_model[[1]]$fstatistic[1], 
                                      res_model[[1]]$fstatistic[2],
                                      res_model[[1]]$fstatistic[3], 
                                      lower.tail = FALSE))),
                        res_model[[1]]$r.squared,
                        fmsb::VIF(lm(localities~.,data=temp[c("localities","ndvi_mean","sum","sum_q95","pop")]))
)


} else {temp_1=rep(NA,13)}
  

names(temp_1)=c("coef_inter","coef_ndvimed","coef_sum","coef_sum_q95","coef_pop",
                 "pv_inter","pv_ndvimed","pv_sum","pv_sum_q95","pv_pop",
                 "Fpvalue","Rsquared","VIF")

res_coefficient_dep_1[[i]]=temp_1

#########################################################################à
if ( res_coefficient_valid_2[[i]]=="yes") {
temp_2=data.frame(cbind(t(res_model[[2]]$coefficients[,1]),
                        t(res_model[[2]]$coefficients[,4]),
                        as.numeric(pf(res_model[[2]]$fstatistic[1], 
                                      res_model[[2]]$fstatistic[2],
                                      res_model[[2]]$fstatistic[3], 
                                      lower.tail = FALSE))),
                       res_model[[2]]$r.squared,
                       fmsb::VIF(lm(coltures~.,data=temp[c("coltures","ndvi_mean","sum","sum_q95","pop")]))
)


} else {temp_2=rep(NA,13)}


names(temp_2)=c("coef_inter","coef_ndvimed","coef_sum","coef_sum_q95","coef_pop",
                "pv_inter","pv_ndvimed","pv_sum","pv_sum_q95","pv_pop",
                "Fpvalue","Rsquared","VIF")

res_coefficient_dep_2[[i]]=temp_2

#########################################################################à
if ( res_coefficient_valid_3[[i]]=="yes") {
temp_3=data.frame(cbind(t(res_model[[3]]$coefficients[,1]),
                        t(res_model[[3]]$coefficients[,4]),
                        as.numeric(pf(res_model[[3]]$fstatistic[1], 
                                      res_model[[3]]$fstatistic[2],
                                      res_model[[3]]$fstatistic[3], 
                                      lower.tail = FALSE))),
                        res_model[[3]]$r.squared,
                        fmsb::VIF(lm(persons~.,data=temp[c("persons","ndvi_mean","sum","sum_q95","pop")]))
)


} else {temp_3=rep(NA,13)}


names(temp_3)=c("coef_inter","coef_ndvimed","coef_sum","coef_sum_q95","coef_pop",
                 "pv_inter","pv_ndvimed","pv_sum","pv_sum_q95","pv_pop",
                 "Fpvalue","Rsquared","VIF")

res_coefficient_dep_3[[i]]=temp_3

#########################################################################à
if ( res_coefficient_valid_4[[i]]=="yes") {
temp_4=data.frame(cbind(t(res_model[[4]]$coefficients[,1]),
                        t(res_model[[4]]$coefficients[,4]),
                        as.numeric(pf(res_model[[4]]$fstatistic[1], 
                                      res_model[[4]]$fstatistic[2],
                                      res_model[[4]]$fstatistic[3], 
                                      lower.tail = FALSE))),
                        res_model[[4]]$r.squared,
                        fmsb::VIF(lm(houses~.,data=temp[c("houses","ndvi_mean","sum","sum_q95","pop")]))
                        )

} else {temp_4=rep(NA,13)}


names(temp_4)=c("coef_inter","coef_ndvimed","coef_sum","coef_sum_q95","coef_pop",
                 "pv_inter","pv_ndvimed","pv_sum","pv_sum_q95","pv_pop",
                 "Fpvalue","Rsquared","VIF")

res_coefficient_dep_4[[i]]=temp_4
#########################################################################à
if ( res_coefficient_valid_5[[i]]=="yes") {
  
temp_5=data.frame(cbind(t(res_model[[5]]$coefficients[,1]),
                        t(res_model[[5]]$coefficients[,4]),
                        as.numeric(pf(res_model[[5]]$fstatistic[1], 
                                      res_model[[5]]$fstatistic[2],
                                      res_model[[5]]$fstatistic[3], 
                                      lower.tail = FALSE))),
                        res_model[[5]]$r.squared,
                        fmsb::VIF(lm(animals~.,data=temp[c("animals","ndvi_mean","sum","sum_q95","pop")]))
                        )


} else {temp_5=rep(NA,13)}


names(temp_5)=c("coef_inter","coef_ndvimed","coef_sum","coef_sum_q95","coef_pop",
                "pv_inter","pv_ndvimed","pv_sum","pv_sum_q95","pv_pop",
                "Fpvalue","Rsquared","VIF")

res_coefficient_dep_5[[i]]=temp_5


#############################################################################################################

idna=which(!is.na(temp$ndvi_mean))

res_trend_dep[[i]]=data.frame(namedep=name_deps[i],
           locsum=sum(temp$localities,na.rm=T),
           coltsum=sum(temp$coltures,na.rm=T),
           perssum=sum(temp$persons,na.rm=T),
           housessum=sum(temp$houses,na.rm=T),
           animessum=sum(temp$animals,na.rm=T),
           Tndvi_mean=sens.slope(ts(temp$ndvi_mean[idna]))$estimates,
           Tgp=sens.slope(ts(temp$gp))$estimates,
           Tq95=sens.slope(ts(temp$q95))$estimates,
           Tsum=sens.slope(ts(temp$sum))$estimates,
           Tsum_q95=sens.slope(ts(temp$sum_q95))$estimates,
           Tpop=sens.slope(ts(temp$pop))$estimates,
           STndvi_mean=sens.slope(ts(temp$ndvi_mean[idna]))$p.value,
           STgp=sens.slope(ts(temp$gp))$p.value,
           STq95=sens.slope(ts(temp$q95))$p.value,
           STsum=sens.slope(ts(temp$sum))$p.value,
           STsum_q95=sens.slope(ts(temp$sum_q95))$p.value,
           STpop=sens.slope(ts(temp$pop))$p.value,
           BSTndvi_mean=ifelse(sens.slope(ts(temp$ndvi_mean[idna]))$p.value<0.1,1,0),
           BSTgp=ifelse(sens.slope(ts(temp$gp))$p.value<0.1,1,0),
           BSTq95=ifelse(sens.slope(ts(temp$q95))$p.value<0.1,1,0),
           BSTsum=ifelse(sens.slope(ts(temp$sum))$p.value<0.1,1,0),
           BSTsum_q95=ifelse(sens.slope(ts(temp$sum_q95))$p.value<0.1,1,0),
           BSTpop=ifelse(sens.slope(ts(temp$pop))$p.value<0.1,1,0),
           pv.mkndvi=mk.test(ts(temp$gp))$p.value,
           pv.mkgp=mk.test(ts(temp$gp))$p.value,
           pv.mkq95=mk.test(ts(temp$q95))$p.value,
           pv.mksum=mk.test(ts(temp$sum))$p.value,
           pv.mksum_q95=mk.test(ts(temp$sum_q95))$p.value,
           pv.mkpop=mk.test(ts(temp$pop))$p.value,
           Bpv.ndvi_mean=ifelse(mk.test(ts(temp$ndvi_mean[idna]))$p.value<0.1,1,0),
           Bpv.gp=ifelse(mk.test(ts(temp$gp))$p.value<0.1,1,0),
           Bpv.q95=ifelse(mk.test(ts(temp$q95))$p.value<0.1,1,0),
           Bpv.sum=ifelse(mk.test(ts(temp$sum))$p.value<0.1,1,0),
           Bpv.sum_q95=ifelse(mk.test(ts(temp$sum_q95))$p.value<0.1,1,0),
           Bpv.pop=ifelse(mk.test(ts(temp$pop))$p.value<0.1,1,0)
           )

res_trend_dep_long[[i]]=data.frame(namedep=name_deps[i],
                                   Tgp=sens.slope(ts(temp_pars_full$gp))$estimates,
                                   Tq95=sens.slope(ts(temp_pars_full$q95))$estimates,
                                   Tsum=sens.slope(ts(temp_pars_full$sum))$estimates,
                                   Tsum_q95=sens.slope(ts(temp_pars_full$sum_q95))$estimates,
                                   Tmax=sens.slope(ts(temp_pars_full$max))$estimates,
                                   STgp=sens.slope(ts(temp_pars_full$gp))$p.value,
                                   STq95=sens.slope(ts(temp_pars_full$q95))$p.value,
                                   STsum=sens.slope(ts(temp_pars_full$sum))$p.value,
                                   STsum_q95=sens.slope(ts(temp_pars_full$sum_q95))$p.value,
                                   STmax=sens.slope(ts(temp_pars_full$max))$p.value,
                                   BSTgp=ifelse(sens.slope(ts(temp_pars_full$gp))$p.value<0.1,1,0),
                                   BSTq95=ifelse(sens.slope(ts(temp_pars_full$q95))$p.value<0.1,1,0),
                                   BSTsum=ifelse(sens.slope(ts(temp_pars_full$sum))$p.value<0.1,1,0),
                                   BSTsum_q95=ifelse(sens.slope(ts(temp_pars_full$sum_q95))$p.value<0.1,1,0),
                                   BSTmax=ifelse(sens.slope(ts(temp_pars_full$max))$p.value<0.1,1,0),
                                   pv.mkgp=mk.test(ts(temp_pars_full$gp))$p.value,
                                   pv.mkq95=mk.test(ts(temp_pars_full$q95))$p.value,
                                   pv.mksum=mk.test(ts(temp_pars_full$sum))$p.value,
                                   pv.mksum_q95=mk.test(ts(temp_pars_full$sum_q95))$p.value,
                                   pv.mkmax=mk.test(ts(temp_pars_full$max))$p.value,
                                   Bpv.gp=ifelse(mk.test(ts(temp_pars_full$gp))$p.value<0.1,1,0),
                                   Bpv.q95=ifelse(mk.test(ts(temp_pars_full$q95))$p.value<0.1,1,0),
                                   Bpv.sum=ifelse(mk.test(ts(temp_pars_full$sum))$p.value<0.1,1,0),
                                   Bpv.sum_q95=ifelse(mk.test(ts(temp_pars_full$sum_q95))$p.value<0.1,1,0),
                                   Bpv.max=ifelse(mk.test(ts(temp_pars_full$max))$p.value<0.1,1,0)
                                  )
                                   
                                   
}                           


#[1] "year"         "localities"   "coltures"     "persons"      "houses"       "animals"     
#[7] "ndvi_sd"      "ndvi_mean"    "ndvi_max"     "countpix_q95" "gp"           "max"         
#[13] "q95"          "sum"          "sum_q95"      "pop" 






##########################################################################################################

res_trend_dep_df=do.call("rbind",res_trend_dep)
row.names(res_trend_dep_df)=NULL
res_trend_dep_df_long=do.call("rbind",res_trend_dep_long)

row.names(res_trend_dep_df_long)=NULL
cor(res_trend_dep_df[,2:14])

res_coefficient_dep_1_df=data.frame(dep=res_trend_dep_df$namedep,do.call("rbind",res_coefficient_dep_1))
res_coefficient_dep_2_df=data.frame(dep=res_trend_dep_df$namedep,do.call("rbind",res_coefficient_dep_2))
res_coefficient_dep_3_df=data.frame(dep=res_trend_dep_df$namedep,do.call("rbind",res_coefficient_dep_3))
res_coefficient_dep_4_df=data.frame(dep=res_trend_dep_df$namedep,do.call("rbind",res_coefficient_dep_4))
res_coefficient_dep_5_df=data.frame(dep=res_trend_dep_df$namedep,do.call("rbind",res_coefficient_dep_5))




res_coefficient_valid_1$validity=unlist(res_coefficient_valid_1)
res_coefficient_valid_2$validity=unlist(res_coefficient_valid_2)
res_coefficient_valid_3$validity=unlist(res_coefficient_valid_3)
res_coefficient_valid_4$validity=unlist(res_coefficient_valid_4)
res_coefficient_valid_5$validity=unlist(res_coefficient_valid_5)



##########################################################################################################

file.remove("../excel/NER_res_trend_dep.xls")
file.remove("../excel/NER_res_trend_dep_long.xls")
file.remove("../excel/NER_res_coefficient_dep.xls")

XLConnect::writeWorksheetToFile("../excel/NER_res_trend_dep.xls",res_trend_dep_df,"trend")
XLConnect::writeWorksheetToFile("../excel/NER_res_trend_dep_long.xls",res_trend_dep_df_long,"trend")

XLConnect::writeWorksheetToFile("../excel/NER_res_coefficient_dep.xls",res_coefficient_dep_1_df,"localities")
XLConnect::writeWorksheetToFile("../excel/NER_res_coefficient_dep.xls",res_coefficient_dep_2_df,"coltures")
XLConnect::writeWorksheetToFile("../excel/NER_res_coefficient_dep.xls",res_coefficient_dep_3_df,"persons")
XLConnect::writeWorksheetToFile("../excel/NER_res_coefficient_dep.xls",res_coefficient_dep_4_df,"houses")
XLConnect::writeWorksheetToFile("../excel/NER_res_coefficient_dep.xls",res_coefficient_dep_5_df,"animals")

#####################################################################################################
# Analisys of  Air Massve area

dep="air"

ndvi_mean=c(NA,NA,tapply(as.numeric(air_NDVI_data[[1]][,2]),ndvi_var_data[[1]]$yr,FUN=mean))

veg=data.frame(ndvi_mean=as.vector(ndvi_mean))


zveg=grep(dep,names(rain_data[[1]]))[1]

temp=cbind(year=1998:2015,veg,do.call("cbind",lapply(rain_data,function(x) x[18:35,zveg])))
temp_pars_full=cbind(years=1981:2016,do.call("cbind",lapply(rain_data,function(x) x[,zveg])))

names(temp)=c("year",
              c(names(veg)),
              gsub("_dep_NER_rain.xls","",gsub("data.climateveg/","",rain_var)))

names(temp_pars_full)=c("year",
                        gsub("_dep_NER_rain.xls","",gsub("data.climateveg/","",rain_var)))


idna=which(!is.na(temp$ndvi_mean))

res_trend_air=data.frame(namedep="air",
                              Tndvi_mean=sens.slope(ts(temp$ndvi_mean[idna]))$estimates,
                              Tgp=sens.slope(ts(temp$gp))$estimates,
                              Tq95=sens.slope(ts(temp$q95))$estimates,
                              Tsum=sens.slope(ts(temp$sum))$estimates,
                              Tsum_q95=sens.slope(ts(temp$sum_q95))$estimates,
                              STndvi_mean=sens.slope(ts(temp$ndvi_mean[idna]))$p.value,
                              STgp=sens.slope(ts(temp$gp))$p.value,
                              STq95=sens.slope(ts(temp$q95))$p.value,
                              STsum=sens.slope(ts(temp$sum))$p.value,
                              STsum_q95=sens.slope(ts(temp$sum_q95))$p.value,
                              BSTndvi_mean=ifelse(sens.slope(ts(temp$ndvi_mean[idna]))$p.value<0.05,1,0),
                              BSTgp=ifelse(sens.slope(ts(temp$gp))$p.value<0.05,1,0),
                              BSTq95=ifelse(sens.slope(ts(temp$q95))$p.value<0.05,1,0),
                              BSTsum=ifelse(sens.slope(ts(temp$sum))$p.value<0.05,1,0),
                              BSTsum_q95=ifelse(sens.slope(ts(temp$sum_q95))$p.value<0.05,1,0),
                              pv.mkndvi=mk.test(ts(temp$gp))$p.value,
                              pv.mkgp=mk.test(ts(temp$gp))$p.value,
                              pv.mkq95=mk.test(ts(temp$q95))$p.value,
                              pv.mksum=mk.test(ts(temp$sum))$p.value,
                              pv.mksum_q95=mk.test(ts(temp$sum_q95))$p.value,
                              Bpv.ndvi_mean=ifelse(mk.test(ts(temp$ndvi_mean[idna]))$p.value<0.1,1,0),
                              Bpv.gp=ifelse(mk.test(ts(temp$gp))$p.value<0.1,1,0),
                              Bpv.q95=ifelse(mk.test(ts(temp$q95))$p.value<0.1,1,0),
                              Bpv.sum=ifelse(mk.test(ts(temp$sum))$p.value<0.1,1,0),
                              Bpv.sum_q95=ifelse(mk.test(ts(temp$sum_q95))$p.value<0.1,1,0)
)

res_trend_long_air=data.frame(namedep="air",
                                   Tgp=sens.slope(ts(temp_pars_full$gp))$estimates,
                                   Tq95=sens.slope(ts(temp_pars_full$q95))$estimates,
                                   Tsum=sens.slope(ts(temp_pars_full$sum))$estimates,
                                   Tsum_q95=sens.slope(ts(temp_pars_full$sum_q95))$estimates,
                                   Tmax=sens.slope(ts(temp_pars_full$max))$estimates,
                                   STgp=sens.slope(ts(temp_pars_full$gp))$p.value,
                                   STq95=sens.slope(ts(temp_pars_full$q95))$p.value,
                                   STsum=sens.slope(ts(temp_pars_full$sum))$p.value,
                                   STsum_q95=sens.slope(ts(temp_pars_full$sum_q95))$p.value,
                                   STmax=sens.slope(ts(temp_pars_full$max))$p.value,
                                   BSTgp=ifelse(sens.slope(ts(temp_pars_full$gp))$p.value<0.1,1,0),
                                   BSTq95=ifelse(sens.slope(ts(temp_pars_full$q95))$p.value<0.1,1,0),
                                   BSTsum=ifelse(sens.slope(ts(temp_pars_full$sum))$p.value<0.1,1,0),
                                   BSTsum_q95=ifelse(sens.slope(ts(temp_pars_full$sum_q95))$p.value<0.1,1,0),
                                   BSTmax=ifelse(sens.slope(ts(temp_pars_full$max))$p.value<0.1,1,0),
                                   pv.mkgp=mk.test(ts(temp_pars_full$gp))$p.value,
                                   pv.mkq95=mk.test(ts(temp_pars_full$q95))$p.value,
                                   pv.mksum=mk.test(ts(temp_pars_full$sum))$p.value,
                                   pv.mksum_q95=mk.test(ts(temp_pars_full$sum_q95))$p.value,
                                   pv.mkmax=mk.test(ts(temp_pars_full$max))$p.value,
                                   Bpv.gp=ifelse(mk.test(ts(temp_pars_full$gp))$p.value<0.1,1,0),
                                   Bpv.q95=ifelse(mk.test(ts(temp_pars_full$q95))$p.value<0.1,1,0),
                                   Bpv.sum=ifelse(mk.test(ts(temp_pars_full$sum))$p.value<0.1,1,0),
                                   Bpv.sum_q95=ifelse(mk.test(ts(temp_pars_full$sum_q95))$p.value<0.1,1,0),
                                   Bpv.max=ifelse(mk.test(ts(temp_pars_full$max))$p.value<0.1,1,0)
                              
)

file.remove("../excel/NER_massiveair_analisys.xls")

XLConnect::writeWorksheetToFile("../excel/NER_massiveair_analisys.xls",temp,"data 1998-2015")
XLConnect::writeWorksheetToFile("../excel/NER_massiveair_analisys.xls",temp_pars_full,"data 1981-2016")
XLConnect::writeWorksheetToFile("../excel/NER_massiveair_analisys.xls",res_trend_air,"trend 1998-2015")
XLConnect::writeWorksheetToFile("../excel/NER_massiveair_analisys.xls",res_trend_long_air,"trend 1981-2016")

